version: '3'

services:

  rails:
    build:
      context: .
      dockerfile: ./rockered/DockerfileRails
      args:
        buildno: 1
    expose:
      - <%= defined?(application_port) ? application_port : '5000' %>
    ports:
      - <%= defined?(application_port) ? "#{application_port}:#{application_port}" : '5000:5000' %>
    links:
      - '<%= database %>:databasehost'

  <%= database %>:
    context: .
      dockerfile: ./<%= database_dockerfile %>
      args:
        buildno: 1
    volumes:
      <% if database == 'mysql' %>- '.<%= defined?(data_dir) ? data_dir : '/rockered/data_dir' %>:/var/lib/mysql:rw' <% end %>
      <% if database == 'postgres' %>- '.<%= defined?(data_dir) ? data_dir : '/rockered/data_dir' %>:/var/lib/postgresql:rw' <% end %>
    ports:
      - '3306:3306'
    environment:
      <% if database == 'mysql' %>- MYSQL_ROOT_PASSWORD=<%= defined?(db_root_pass) ? db_root_pass : 'root' %> <% end %>
      <% if database == 'postgres' %>- POSTGRES_PASSWORD=<%= defined?(db_root_pass) ? db_root_pass : 'root' %> <% end %>
