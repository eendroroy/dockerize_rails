version: '3'

services:

  rails:
    build:
      context: .
      dockerfile: ./rockered/DockerfileRails
      args:
        buildno: 1
    expose:
      - <%= defined?(application_port) ? application_port : '5000' %>
    ports:
      - <%= defined?(application_port) ? "#{application_port}:#{application_port}" : '5000:5000' %>
    links:
      - '<%= database %>:databasehost'

  <%= defined?(database) ? database : 'mysql' %>:
    context: .
      dockerfile: ./<%= database_dockerfile %>
      args:
        buildno: 1
    volumes:
      - '.<%= defined?(data_dir) ? data_dir : '/rockered/data_dir' %>:/var/lib/<%= defined?(database) ? database : 'mysql' %>:rw'
    ports:
      <% if database == 'mysql' %>- '3306:3306'
      <% elsif database == 'postgresql' %>- '5432:5432'
      <% else %>- '3306:3306'
      <% end %>
    environment:
      <% if database == 'mysql' %>- MYSQL_ROOT_PASSWORD=<%= defined?(db_root_pass) ? db_root_pass : 'root' %>
      <% elsif database == 'postgresql' %>- POSTGRES_PASSWORD=<%= defined?(db_root_pass) ? db_root_pass : 'root' %>
      <% else %> - MYSQL_ROOT_PASSWORD=<%= defined?(db_root_pass) ? db_root_pass : 'root' %>
      <% end %>
