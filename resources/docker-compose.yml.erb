version: '3'

services:
  <%= database %>:
    build:
      context: .
      dockerfile: ./<%= "#{Constants::CONFIG_DIRECTORY_NAME}/#{database}/Dockerfile" %>
      args:
        buildno: 1
    volumes:
      - './<%= "#{Constants::CONFIG_DIRECTORY_NAME}/#{database}/#{Constants::DATA_DIRECTORY_NAME}" %>:/var/lib/<%= database %>:rw'
    ports:
      <% if database == 'postgresql' %>- '5432:5432'
      <% elsif database == 'mysql' %>- '3300:3306'<% end %>
    environment:
      <% if database == 'postgresql' %>- POSTGRES_USER=<%= database_user_name %>
      - POSTGRES_PASSWORD=<%= database_user_pass %>
      <% elsif database == 'mysql' %>- MYSQL_ROOT_PASSWORD=<%= db_root_pass %>
      <% if database_user_name != 'root' %>- MYSQL_USER=<%= database_user_name %>
      - MYSQL_PASSWORD=<%= database_user_pass %><% end %>
      <% end %>
  rails:
    build:
      context: .
      dockerfile: ./<%= "#{Constants::CONFIG_DIRECTORY_NAME}/rails/Dockerfile" %>/
      args:
        buildno: 1
    expose:
      - '<%= application_port %>'
    ports:
      - '<%= "#{application_port}:#{application_port}" %>'
    links:
      - '<%= database %>:<%= database_host_name %>'
    depends_on:
      - <%= database %>
